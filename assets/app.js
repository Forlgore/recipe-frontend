const state={data:null,selectedAtoms:new Set,mode:"and",q:"",tags:new Set};const $=e=>document.querySelector(e),$$=e=>Array.from(document.querySelectorAll(e));async function loadData(){const e=await fetch("data/recipes.json"),t=await e.json();t.recipes.forEach(e=>{e.tags=e.tags||[],e.ingredientTags=e.ingredientTags||[],e.ingredientAtoms=e.ingredientAtoms||[]}),state.data=t}function uniqueSorted(e){return[...new Set(e)].sort((e,t)=>e.localeCompare(t))}function computeFacets(){const e=state.data.recipes,t=uniqueSorted(e.flatMap(e=>e.tags||[]));return{allTags:t,allAtoms:uniqueSorted(e.flatMap(e=>e.ingredientAtoms||[]))}}function renderTagSelect(e){const t=$("#tagSelect");t.innerHTML="",e.forEach(e=>{const a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a)})}function renderAtomChips(e){const t=$("#atomChips");t.innerHTML="";const a=$("#atomFilter").value.trim().toLowerCase();e.filter(e=>e.includes(a)).forEach(e=>{const a=document.createElement("button");a.type="button",a.className="chip"+(state.selectedAtoms.has(e)?" selected":""),a.textContent=e,a.setAttribute("aria-pressed",state.selectedAtoms.has(e)),a.addEventListener("click",(()=>{state.selectedAtoms.has(e)?state.selectedAtoms.delete(e):state.selectedAtoms.add(e),renderAtomChips(e),render()})),t.appendChild(a)})}function matchRecipe(e){const t=state.q.toLowerCase();if(t){const a=[e.name,...(e.tags||[]),...(e.ingredientTags||[]),...(e.ingredientAtoms||[])].join(" ").toLowerCase();if(!a.includes(t))return!1}if(state.tags.size){if(![...state.tags].every((t=>e.tags.includes(t))))return!1}const a=[...state.selectedAtoms];return!a.length||("and"===state.mode?a.every((t=>e.ingredientAtoms.includes(t))):a.some((t=>e.ingredientAtoms.includes(t))))}function render(){const e=$("#results");e.innerHTML="";const{allTags:t,allAtoms:a}=computeFacets();renderTagSelect(t),renderAtomChips(a);let n=state.data.recipes.filter(matchRecipe);n.sort(((e,t)=>e.name.localeCompare(t.name)));const s=document.getElementById("recipeCardTmpl");n.forEach((t=>{const a=s.content.cloneNode(!0);a.querySelector(".card-title").textContent=t.name,a.querySelector(".meta").textContent=`Servings: ${t.servings??""}`;const n=a.querySelector(".tags");t.tags.forEach((e=>{const t=document.createElement("span");t.className="tag",t.textContent=e,n.appendChild(t)}));const r=a.querySelector(".ingredients"),o=a.querySelector(".instructions");if(t.components)t.components.forEach((e=>{const t=document.createElement("h4");t.textContent=e.component_name,r.appendChild(t);const a=document.createElement("ul");(e.ingredients||[]).forEach((e=>{const t=document.createElement("li");t.textContent=[e.amount,e.item,e.notes,e.optional?"(optional)":""].filter(Boolean).join(" "),a.appendChild(t)})),r.appendChild(a);const n=document.createElement("h4");n.textContent=e.component_name+" â€“ Steps",o.appendChild(n);const s=document.createElement("ol");(e.instructions||[]).forEach((e=>{const t=document.createElement("li");t.textContent=e,s.appendChild(t)})),o.appendChild(s)}));else{const e=document.createElement("h4");e.textContent="Ingredients",r.appendChild(e);const t=document.createElement("ul");(t=>{(t.ingredients||[]).forEach((e=>{const a=document.createElement("li");a.textContent=[e.amount,e.item,e.notes,e.optional?"(optional)":""].filter(Boolean).join(" "),t.appendChild(a)}))})(t),r.appendChild(t);const a=document.createElement("h4");a.textContent="Instructions",o.appendChild(a);const n=document.createElement("ol");(t.instructions||[]).forEach((e=>{const t=document.createElement("li");t.textContent=e,n.appendChild(t)})),o.appendChild(n)}e.appendChild(a)})),n.length||(()=>{const t=document.createElement("div");t.textContent="No recipes match your filters.",e.appendChild(t)})();const c=new URLSearchParams;state.q&&c.set("q",state.q),state.tags.size&&c.set("tags",[...state.tags].join(",")),state.selectedAtoms.size&&c.set("atoms",[...state.selectedAtoms].join(",")),c.set("mode",state.mode),history.replaceState({},"","?"+c.toString())}function restoreFromURL(){const e=new URL(location.href),t=e.searchParams.get("q")||"",a=(e.searchParams.get("tags")||"").split(",").filter(Boolean),n=(e.searchParams.get("atoms")||"").split(",").filter(Boolean),s=e.searchParams.get("mode")||"and";$("#q").value=t,state.q=t,state.mode=s,state.tags=new Set(a),state.selectedAtoms=new Set(n)}function setupEvents(){$("#q").addEventListener("input",(e=>{state.q=e.target.value.trim(),render()})),$("#tagSelect").addEventListener("change",(e=>{const t=Array.from(e.target.selectedOptions).map((e=>e.value));state.tags=new Set(t),render()})),$$("#atomChips .chip").forEach((e=>e.addEventListener("click",render))),$$("#atom-mode input").forEach((e=>e.addEventListener("change",(()=>{state.mode=e.value,render()})))),document.body.addEventListener("change",(e=>{"mode"===e.target.name&&(state.mode=e.target.value,render())})),$("#atomFilter").addEventListener("input",(()=>render())),$("#clearBtn").addEventListener("click",(()=>{state.q="",state.tags.clear(),state.selectedAtoms.clear(),state.mode="and",$("#q").value="",$("#atomFilter").value="",render()}))} (async function(){await loadData(),restoreFromURL(),setupEvents(),render()})();